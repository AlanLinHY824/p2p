<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>动力金融网-CFCA认证的互联网金融公司</title>
<script type="text/javascript" th:src="@{/js/jquery-1.7.2.min.js}"></script>
  <script type="text/javascript" th:src="@{/bootstrap_3.3.0/jquery-1.11.1-min.js}"></script>
  <link th:href="@{/bootstrap_3.3.0/css/bootstrap.min.css}" type="text/css" rel="stylesheet" />
<script type="text/javascript" th:src="@{/js/trafficStatistics.js}"></script>
  <link th:href="@{/bs_pagination/jquery.bs_pagination.min.css}" type="text/css" rel="stylesheet" />
  <script type="text/javascript" th:src="@{/bs_pagination/en.js}"></script>
  <script type="text/javascript" th:src="@{/bootstrap_3.3.0/js/bootstrap.min.js}"></script>
<!--  <script type="text/javascript" th:src="@{/bootstrap_3.3.0/css/bootstrap.min.css}"></script>-->


  <script type="text/javascript" th:src="@{/bs_pagination/jquery.bs_pagination.min.js}"></script>
<link rel="stylesheet" type="text/css" th:href="@{/css/style.css}" />
<link rel="stylesheet" type="text/css" th:href="@{/css/share.css}" />
<link rel="stylesheet" type="text/css" th:href="@{/css/main.css}" />

</head>

<body>
<div id="header">
<!--<jsp:include page="commons/header.jsp"/>-->
    <div th:include="commons/header :: html"></div>
</div>

<!--散标投资 begin-->
<div id="sbtz" class="invest-details">

<!--页中begin-->
<div class="mainBox pro-details-body">
  <div class="homeWap clearfix" id="huacengPar">
    <div class="pro-details-left">
      
      <!-- 产品详情start -->
      <div class="pro-info-details">
        <div class="pro-name">
          <h2><span th:text="|${bLoanInfoById.productName}(${#dates.format(bLoanInfoById.releaseTime,'yyyyMMdd')}期)|">季度宝 (20170726期)</span></h2>
        </div>
        <div class="pro-info">
          <ul class="clearfix">
            <li class="info-1">
              <p>历史年化利率</p>
              <h3 th:text="|${bLoanInfoById.rate}%|">4.9%</h3>
              <div class="info-bt">
              <span>本产品采用普通利率</span>
              </div>
            </li>
            <li class="info-2">
              <p>募集金额(元)</p>
              <h3 th:text="${bLoanInfoById.productMoney}">500000.0</h3>
              <div class="info-bt">
                  <!-- 只有状态为0时为募集，其它都为已满标 -->

                  <!-- 已满标 -->
              	<span th:if="${bLoanInfoById.productStatus==0}">
                    <span th:text="|募集中,剩余募集金额${bLoanInfoById.leftProductMoney}元|">
                    </span>
              	</span>
                <span th:if="${bLoanInfoById.productStatus!=0 }">
                    <span th:text="已满标">
                    </span>
              	</span>
              </div>
            </li>
            <li class="info-3">
              <p>投资周期</p>
              <!-- 只有新手宝产品周期为天 -->
              <h3 th:text="${bLoanInfoById.cycle}+${bLoanInfoById.productType==0?'天':'个月'}">6<span>个月</span></h3>
              <div class="info-bt"><span></span></div>
            </li>
          </ul>
        </div>
        <dl class="pro-syfs">
          <dt><span>收益获取方式</span></dt>
          <dd><span>收益返还：</span>到期还本付息</dd>
        </dl>
      </div>
      <!-- 产品详情end -->
      
      <!-- 投资记录start -->
      <div class="pro-details-cnt">
        <ul class="tabNav clearfix">
          <li><a id="one3" href="javascript:void(0);" class="s">投资记录</a></li>
        </ul>
        
        <div class="invest-record" id="con_one_3" style="display:block">
        <div class="vertical-side">投资列表</div>
		<dl class="record-list">
		<dt>
			<span class="record-num">序号</span><span class="invest-user">投资人</span><span class="invest-money">投资金额(元)</span><span class="invest-time">投资时间</span>
		</dt>
		
<!--        &lt;!&ndash; 如果投资记录为空，显示以下文字 &ndash;&gt;-->
<!--        <div th:if="${#lists.size(bBidInfos)==0}">-->
<!--            <dd style="text-align:center;">该产品暂时还没有人投资，赶快去投资吧~</dd>-->
<!--        </div>-->
<!--		&lt;!&ndash; 如果有投资记录，循环遍历显示 &ndash;&gt;-->
<!--        <div th:if="${#lists.size(bBidInfos)>0}">-->
<!--            <span th:each="bBidInfo:${bBidInfos}">-->
<!--                <dd>-->
<!--                <span class="record-num" th:text="${bBidInfoStat.count}">1</span>-->
<!--                <span class="invest-user" th:text="${#strings.substring(bBidInfo.user.phone,0,3)+'******'+#strings.substring(bBidInfo.user.phone,9,11)}">137******89</span>-->
<!--                <span class="invest-money" th:text="${bBidInfo.bidMoney}">>1000.0</span>-->
<!--                <span class="invest-time" th:text="${#dates.format(bBidInfo.bidTime,'yyyy-MM-dd HH:mm:ss')}">2017-09-12 13:34:22</span>-->
<!--                </dd>-->
<!--            </span>-->
<!--        </div>-->
          <div id="bidList">

          </div>
          <div id="bidPage">

          </div>
		</dl>
		</div>
      </div>
      <!-- 投资记录end -->
    </div>
    
    <!--页面右侧begin-->
    <div class="pro-details-right">
      <div class="right-calculator" id="huaceng">
        <div class="calculator-cnt">
          <h2>立即投资</h2>
          <dl class="profits-mode">
            <dt>收益获取方式</dt>
            <dd class="clearfix"><span id="fanhuan"><em>到期还本付息</em></span></dd>
          </dl>
          <dl class="usable">
            <dt>我的账户可用</dt>
            <dd>资金(元)：
                    <div th:if="${session.user==null}">
	            	<!-- 判断用户是否登录：未登录，显示登录连接 -->
                        <span style="font-size:18px;color:#ff6161;vertical-align:bottom;"><a href="#" onclick="toLogin()">请登录</a></span>
                    </div>
	            	<!-- 判断用户是否登录：已登录，显示可用余额 -->
                    <div th:if="${session.user!=null}">
	           		    <span style="font-size:18px;color:#ff6161;vertical-align:bottom;" th:text="${uFinanceAccount.availableMoney}">1,000,12 元</span>
                    </div>
            </dd>
          </dl>
          <div class="expect-box">
            <div class="expect-money">预计本息收入(元)：<span id="profit" class="money"></span><span class="prompt" style="display:block;">请在下方输入投资金额</span></div>
            <input type="text" id="bidMoney" name="bidMoney" onblur="checkMoney();" placeholder="请输入投资金额，应为100元的整倍数" maxlength="9"/>
            <div class="max-invest-money" id="max-invest-money"></div>
          </div>
          <div class="invest-btn">
          	<a id="investNow" href="javascript:void(0)" class="btn-1" onclick="invest();">立即投资</a>
          </div>
          <input type="hidden" id="loanId" name="loanId" value="${loanInfo.id}"/>
        </div>
      </div>
    </div>
<!--    防止session为null-->
    <div th:if="${session.user!=null}">
      <input type="hidden" id="user"  th:value="${session.user}"/>
      <input type="hidden" id="userName" th:value="${session.user.name}"/>
      <input type="hidden" id="availableMoney"  th:value="${uFinanceAccount.availableMoney}"/>
    </div>
    <!--页面右侧end-->
  </div>
</div>
<!--页中end-->

</div>
<!--散标投资 end-->

<!--遮罩层-->
<div class="dialog-overlay" id="dialog-overlay1" style="display:none;"></div>

<!--投资成功浮层start-->
<div class="layer-body failureSuccess failurePayment" id="failurePayment" style="display:none;width:500px;height:100px;top:75%;">
  <a class="layer-close" href="javascript:closeit();"></a>
  <div style="background:#f2f2f2; line-height:105px;text-align:center;"><font style="font-size:25px;">投资成功</font></div>
</div>
<!--投资成功浮层end-->

<!--页脚start-->
<jsp:include page="commons/footer.jsp"/>
<!--页脚end-->

<script type="text/javascript" th:inline="javascript">
function closeit() {
	$("#failurePayment").hide();
	$("#dialog-overlay1").hide();
    window.location.href=rootPath+"/loan/myCenter";
}
</script>
<script type="text/javascript" th:inline="javascript">
  var rate=[[${bLoanInfoById.rate}]];
  var cycle=[[${bLoanInfoById.cycle}]];
  var productType=[[${bLoanInfoById.productType}]];
  var leftProductMoney=[[${bLoanInfoById.leftProductMoney}]];
  var bidMinLimit=[[${bLoanInfoById.bidMinLimit}]];
  var bidMaxLimit=[[${bLoanInfoById.bidMaxLimit}]];
  var loanId=[[${bLoanInfoById.id}]];
  //账户余额
  var user=$("#user").val();
  var userName=$("#userName").val();
  var availableMoney=$("#availableMoney").val();
  //提示信息栏对象
  var investMoney= $("#max-invest-money");

  function checkMoney(){
    var bidMoney=$.trim($("#bidMoney").val())==""?0:$.trim($("#bidMoney").val());
    investMoney.html("");
    if (parseInt(bidMoney)<parseInt(bidMinLimit)){
      investMoney.html("投资金额不得小于最低起投金额"+parseInt(bidMinLimit));
      return false;
    }
    if (parseInt(bidMoney)>parseInt(bidMaxLimit)){
      investMoney.html("投资金额不得高于最大可投金额"+bidMaxLimit);
      return false;
    }
    if (parseInt(bidMoney)>parseInt(leftProductMoney)){
      investMoney.html("投资金额不得高于剩余可投金额"+leftProductMoney);
      return false;
    }
    if (parseInt(productType)==0){
      $("#profit").text(Math.round((rate/100/365*cycle+1)*parseInt(bidMoney)*100)/100);
    }
    if (parseInt(productType)>0){
      $("#profit").text(Math.round((rate/100/12*cycle+1)*parseInt(bidMoney)*100)/100);
    }
    return true;
  }

  function invest(){
    if (user==null){
      setTimeout(forLogin, 1000);
      return;
    }
    if (userName==null){
      // investMoney.html("您尚未实名认证，将在"+num+"正在跳转至实名认证页面...");
      // window.location.href=rootPath +"/loan/page/realName";
      setTimeout(forRealName, 1000);
      return;
    }
    if (parseInt(bidMoney)>parseInt(availableMoney)){
      //不能超过账户金额
      investMoney.html("账户余额不足，请先充值");
      return;
    }
    if (!checkMoney()){
      return;
    }
    //提交
    $.ajax({
        type: "POST",
        url: rootPath+"/bid/invest",
        data: {
          bidMoney:$.trim($("#bidMoney").val()),
          loanId:loanId
        },
        success: function(data){
          if(data.code==200){
            //window.location.href= rootPath+"/index";
            $("#failurePayment").show();
            $("#dialog-overlay1").show();
          }else{
            investMoney.html("投资失败");

          }
        },
        error:function(){
          investMoney.html("系统繁忙,请稍后再试");

        }
    });

  }
  var num = 3; //倒计时的秒数
  function forRealName(){
    if(num != 0){
      investMoney.html("您尚未实名认证，将在"+num+"正在跳转至实名认证页面...");
      num --;
      setTimeout(forRealName, 1000);
    }else{
      num = 3;
      window.location.href =rootPath +"/loan/page/realName?redictURL="+redictURL;
    }
  }
  function forLogin(){
    if(num != 0){
      investMoney.html("您尚未登陆，将在"+num+"正在跳转至登陆界面...");
      num --;
      setTimeout(forLogin, 1000);
    }else{
      num = 3;
      window.location.href =rootPath +"/loan/page/login?redictURL="+redictURL;
    }
  }

  $(function () {
    pageList(1);
  });
  //投资纪录的ajax分页
  function pageList(currentPage) {
    $.ajax({
      url:[[${#request.getContextPath()}]]+"/loan/bidInfo/[[${bLoanInfoById.id}]]?currentPage="+currentPage,
      type:"get",
      dataType:"json",
      success:function (data) {
        var bBidInfos=data.bBidInfos;
        var pageModel=data.pageModel;
        var html="";
        for (var i = 0; i <bBidInfos.length; i++) {
          html+="<dd>\n" +
                  "<span class=\"record-num\" >"+(i+1)+"</span>\n" +
                  "<span class=\"invest-user\">"+bBidInfos[i].user.phone.substr(0,3)+"******"+bBidInfos[i].user.phone.substr(9,2)+"</span>\n" +
                  "<span class=\"invest-money\">"+bBidInfos[i].bidMoney+"</span>\n" +
                  "<span class=\"invest-time\">"+bBidInfos[i].bidTime+"</span>\n" +
                  "</dd>";
        }
        $("#bidList").html(html);
        $("#bidPage").bs_pagination({
          currentPage: pageModel.currentPage, // 页码
          rowsPerPage: pageModel.pageSize, // 每页显示的记录条数
          maxRowsPerPage: 20, // 每页最多显示的记录条数
          totalPages: pageModel.totalPages, // 总页数
          totalRows: pageModel.totalRecordCounts, // 总记录条数
          visiblePageLinks: 3, // 显示几个卡片
          showGoToPage: true,
          showRowsPerPage: true,
          showRowsInfo: true,
          showRowsDefaultInfo: true,
          onChangePage : function(event, object){
            pageList(object.currentPage);
          }
        });
      }
    })
  }


</script>
</body>
</html>